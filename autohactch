-- ==================== AUTO HATCH MODULE ====================
-- Load tá»«: https://raw.githubusercontent.com/maihoangphi2531/REPO/main/autohatch.luaa
-- YÃªu cáº§u: WindUI, cÃ¡c biáº¿n global tá»« file chÃ­nh
-- ===========================================================

local Module = {}

-- âœ… Láº¥y cÃ¡c biáº¿n cáº§n thiáº¿t tá»« file chÃ­nh
local WindUI = _G.WindUI
local Window = _G.Window
local Players = game:GetService("Players")
local c = _G.PlayerLocal
local d = _G.UserId
local e = _G.HttpService
local ConfigSystem = _G.ConfigSystem
local Toggles = _G.Toggles
local Options = _G.Options

-- âœ… Láº¥y ReplicatedStorage references
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Shared = ReplicatedStorage:WaitForChild("Shared")
local ItemsModule = require(Shared:WaitForChild("Items"))
local BuyEggRemote = Shared:WaitForChild("Pets"):WaitForChild("BuyEgg")
local EquipItemRemote = Shared:WaitForChild("Inventory"):WaitForChild("EquipItem")

-- âœ… Láº¥y Player references
local PlayerGui = c:WaitForChild("PlayerGui")
local Profile = PlayerGui:WaitForChild("Profile")
local InventoryItems = Profile:WaitForChild("Inventory"):WaitForChild("Items")
local PlayerEquips = ReplicatedStorage:WaitForChild("PlayerEquips"):WaitForChild(c.Name)
local PetEquip = PlayerEquips:WaitForChild("Pet")

-- ==================== GLOBALS ====================
local HatchGlobals = {
    isAutoHatching = false,
    isAutoBuying = false,
    selectedEgg = "",
    purchaseMethod = "Gold", -- "Gold" hoáº·c "Gems"
    eggsList = {},
    totalEggsBought = 0,
    totalEggsHatched = 0,
    sessionStartTime = 0,
    -- Config
    ConfigFile = "AnyaHub_HatchConfig_" .. c.Name .. ".txt"
}

-- ==================== UTILITY FUNCTIONS ====================
local function libNoti(msg, duration)
    WindUI:Notify({
        Title = "Auto Hatch",
        Content = msg,
        Duration = duration or 5
    })
end

local function formatNumber(num)
    if num >= 1000000 then
        return string.format("%.1fM", num / 1000000)
    elseif num >= 1000 then
        return string.format("%.1fK", num / 1000)
    else
        return tostring(num)
    end
end

local function timeElapsed(seconds)
    local hours = math.floor(seconds / 3600)
    local mins = math.floor((seconds % 3600) / 60)
    local secs = seconds % 60
    
    if hours > 0 then
        return string.format("%dh %dm %ds", hours, mins, secs)
    elseif mins > 0 then
        return string.format("%dm %ds", mins, secs)
    else
        return string.format("%ds", secs)
    end
end

-- ==================== EGG FUNCTIONS ====================
-- Láº¥y danh sÃ¡ch eggs tá»« Items module
local function getEggsList()
    local eggs = {}
    
    for itemName, itemData in pairs(ItemsModule) do
        -- Kiá»ƒm tra xem cÃ³ pháº£i lÃ  egg khÃ´ng (thÆ°á»ng cÃ³ Type = "Egg" hoáº·c tÃªn chá»©a "Egg")
        if itemData.Type == "Egg" or string.match(itemName, "Egg") then
            table.insert(eggs, itemName)
        end
    end
    
    table.sort(eggs)
    
    -- Náº¿u khÃ´ng tÃ¬m tháº¥y eggs, thÃªm má»™t sá»‘ eggs phá»• biáº¿n
    if #eggs == 0 then
        eggs = {
            "StarterEgg",
            "ForestEgg", 
            "DesertEgg",
            "ArcticEgg",
            "VolcanoEgg",
            "OceanEgg",
            "SpaceEgg",
            "MythicEgg",
            "LegendaryEgg",
            "StarEgg"
        }
    end
    
    return eggs
end

-- Mua egg
local function buyEgg(eggName, method)
    if not eggName or eggName == "" then
        return false
    end
    
    local success = pcall(function()
        BuyEggRemote:FireServer(eggName, method or "Gold")
    end)
    
    if success then
        HatchGlobals.totalEggsBought = HatchGlobals.totalEggsBought + 1
    end
    
    return success
end

-- TÃ¬m táº¥t cáº£ eggs trong inventory
local function findEggsInInventory()
    local eggs = {}
    
    for _, item in ipairs(InventoryItems:GetChildren()) do
        -- Kiá»ƒm tra xem item cÃ³ pháº£i lÃ  egg khÃ´ng
        local itemName = item.Name
        if string.match(itemName, "Egg") or (ItemsModule[itemName] and ItemsModule[itemName].Type == "Egg") then
            table.insert(eggs, item)
        end
    end
    
    return eggs
end

-- Hatch má»™t egg tá»« inventory
local function hatchEgg(eggItem)
    if not eggItem or not eggItem.Parent then
        return false
    end
    
    local success = pcall(function()
        EquipItemRemote:FireServer(eggItem, PetEquip)
    end)
    
    if success then
        HatchGlobals.totalEggsHatched = HatchGlobals.totalEggsHatched + 1
    end
    
    return success
end

-- Hatch táº¥t cáº£ eggs trong inventory
local function hatchAllEggs()
    local eggs = findEggsInInventory()
    local hatchedCount = 0
    
    for _, egg in ipairs(eggs) do
        if hatchEgg(egg) then
            hatchedCount = hatchedCount + 1
            task.wait(0.1) -- Delay nhá» giá»¯a cÃ¡c láº§n hatch
        end
    end
    
    return hatchedCount
end

-- ==================== AUTO FUNCTIONS ====================
local function startAutoBuy()
    if HatchGlobals.isAutoBuying then
        warn("âš ï¸ Auto Buy Ä‘Ã£ Ä‘ang cháº¡y!")
        return
    end
    
    if not HatchGlobals.selectedEgg or HatchGlobals.selectedEgg == "" then
        libNoti("âŒ Vui lÃ²ng chá»n egg trÆ°á»›c!", 3)
        return
    end
    
    HatchGlobals.isAutoBuying = true
    HatchGlobals.sessionStartTime = tick()
    
    libNoti("âœ… Báº¯t Ä‘áº§u Auto Buy: " .. HatchGlobals.selectedEgg, 3)
    
    task.spawn(function()
        while Toggles.AutoBuyEgg and Toggles.AutoBuyEgg.Value do
            local success = buyEgg(HatchGlobals.selectedEgg, HatchGlobals.purchaseMethod)
            
            if not success then
                task.wait(1)
            else
                -- Delay dá»±a trÃªn Options
                local delay = Options.BuyDelay and Options.BuyDelay.Value or 0.5
                task.wait(delay)
            end
        end
        
        HatchGlobals.isAutoBuying = false
        libNoti("â¹ï¸ ÄÃ£ dá»«ng Auto Buy", 3)
    end)
end

local function startAutoHatch()
    if HatchGlobals.isAutoHatching then
        warn("âš ï¸ Auto Hatch Ä‘Ã£ Ä‘ang cháº¡y!")
        return
    end
    
    HatchGlobals.isAutoHatching = true
    HatchGlobals.sessionStartTime = tick()
    
    libNoti("âœ… Báº¯t Ä‘áº§u Auto Hatch", 3)
    
    task.spawn(function()
        while Toggles.AutoHatchEgg and Toggles.AutoHatchEgg.Value do
            local hatchedCount = hatchAllEggs()
            
            if hatchedCount == 0 then
                task.wait(2) -- Äá»£i lÃ¢u hÆ¡n náº¿u khÃ´ng cÃ³ egg
            else
                -- Delay dá»±a trÃªn Options
                local delay = Options.HatchDelay and Options.HatchDelay.Value or 0.5
                task.wait(delay)
            end
        end
        
        HatchGlobals.isAutoHatching = false
        libNoti("â¹ï¸ ÄÃ£ dá»«ng Auto Hatch", 3)
    end)
end

-- ==================== CONFIG FUNCTIONS ====================
local function saveHatchConfig()
    if not writefile then return end
    
    local data = {
        selectedEgg = HatchGlobals.selectedEgg,
        purchaseMethod = HatchGlobals.purchaseMethod,
        totalEggsBought = HatchGlobals.totalEggsBought,
        totalEggsHatched = HatchGlobals.totalEggsHatched
    }
    
    pcall(function()
        writefile(HatchGlobals.ConfigFile, e:JSONEncode(data))
    end)
    
    warn("ðŸ’¾ ÄÃ£ lÆ°u Hatch config")
end

local function loadHatchConfig()
    if not (isfile and readfile and isfile(HatchGlobals.ConfigFile)) then
        return false
    end
    
    local success = pcall(function()
        local data = e:JSONDecode(readfile(HatchGlobals.ConfigFile))
        
        HatchGlobals.selectedEgg = data.selectedEgg or ""
        HatchGlobals.purchaseMethod = data.purchaseMethod or "Gold"
        HatchGlobals.totalEggsBought = data.totalEggsBought or 0
        HatchGlobals.totalEggsHatched = data.totalEggsHatched or 0
    end)
    
    if success then
        warn("ðŸ“‚ ÄÃ£ load Hatch config")
    end
    
    return success
end

-- ==================== UI CREATION ====================
local function createAutoHatchTab()
    -- Khá»Ÿi táº¡o Options wrapper cho delays
    if not Options.BuyDelay then
        Options.BuyDelay = { Value = 0.5, SetValue = function(self, val) self.Value = val end }
    end
    if not Options.HatchDelay then
        Options.HatchDelay = { Value = 0.5, SetValue = function(self, val) self.Value = val end }
    end
    
    local TabHatch = Window:Tab({
        Title = "Auto Hatch",
        Icon = "egg",
        Locked = false
    })
    
    TabHatch:Section({ Title = "ðŸ¥š Auto Egg System" })
    
    -- Info paragraph
    TabHatch:Paragraph({
        Title = "â„¹ï¸ HÆ°á»›ng Dáº«n",
        Description = "â€¢ Chá»n loáº¡i egg muá»‘n mua\nâ€¢ Chá»n phÆ°Æ¡ng thá»©c thanh toÃ¡n (Gold/Gems)\nâ€¢ Báº­t Auto Buy Ä‘á»ƒ tá»± Ä‘á»™ng mua egg\nâ€¢ Báº­t Auto Hatch Ä‘á»ƒ tá»± Ä‘á»™ng ná»Ÿ egg tá»« inventory"
    })
    
    TabHatch:Divider({ Text = "Egg Selection" })
    
    -- Láº¥y danh sÃ¡ch eggs
    HatchGlobals.eggsList = getEggsList()
    
    -- Dropdown chá»n egg
    local EggDropdown = TabHatch:Dropdown({
        Title = "ðŸ“‹ Chá»n Egg",
        Description = "Chá»n loáº¡i egg muá»‘n mua",
        Values = HatchGlobals.eggsList,
        Multi = false,
        Default = HatchGlobals.selectedEgg ~= "" and {HatchGlobals.selectedEgg} or nil,
        Callback = function(selected)
            -- WindUI tráº£ vá» table vá»›i 1 pháº§n tá»­ khi Multi = false
            local eggName = type(selected) == "table" and selected[1] or selected
            if eggName and eggName ~= "" then
                HatchGlobals.selectedEgg = eggName
                saveHatchConfig()
                warn("âœ… ÄÃ£ chá»n egg:", HatchGlobals.selectedEgg)
                libNoti("âœ… ÄÃ£ chá»n: " .. eggName, 2)
            end
        end
    })
    ConfigSystem.registerUIElement("selectedEgg", EggDropdown)
    
    -- Dropdown chá»n payment method
    local PaymentDropdown = TabHatch:Dropdown({
        Title = "ðŸ’° PhÆ°Æ¡ng Thá»©c Thanh ToÃ¡n",
        Description = "Chá»n Gold hoáº·c Gems",
        Values = {"Gold", "Gems"},
        Multi = false,
        Default = {HatchGlobals.purchaseMethod},
        Callback = function(selected)
            local method = type(selected) == "table" and selected[1] or selected
            if method and method ~= "" then
                HatchGlobals.purchaseMethod = method
                saveHatchConfig()
                warn("âœ… PhÆ°Æ¡ng thá»©c:", HatchGlobals.purchaseMethod)
                libNoti("âœ… PhÆ°Æ¡ng thá»©c: " .. method, 2)
            end
        end
    })
    ConfigSystem.registerUIElement("purchaseMethod", PaymentDropdown)
    
    TabHatch:Divider({ Text = "Auto Buy Settings" })
    
    -- Buy delay slider
    local BuyDelaySlider = TabHatch:Slider({
        Title = "â±ï¸ Buy Delay",
        Description = "Äá»™ trá»… giá»¯a cÃ¡c láº§n mua (giÃ¢y)",
        Min = 0.1,
        Max = 5,
        Default = Options.BuyDelay.Value,
        Callback = function(value)
            Options.BuyDelay.Value = value
            warn("âœ… Buy Delay:", value, "giÃ¢y")
        end
    })
    ConfigSystem.registerUIElement("BuyDelay", BuyDelaySlider)
    
    -- Auto buy toggle
    local AutoBuyToggle = TabHatch:Toggle({
        Title = "ðŸ›’ Auto Buy Egg",
        Description = "Tá»± Ä‘á»™ng mua egg Ä‘Ã£ chá»n",
        Default = false,
        Callback = function(state)
            if state then
                startAutoBuy()
            else
                HatchGlobals.isAutoBuying = false
            end
        end
    })
    ConfigSystem.registerUIElement("AutoBuyEgg", AutoBuyToggle)
    
    TabHatch:Divider({ Text = "Auto Hatch Settings" })
    
    -- Hatch delay slider
    local HatchDelaySlider = TabHatch:Slider({
        Title = "â±ï¸ Hatch Delay",
        Description = "Äá»™ trá»… giá»¯a cÃ¡c láº§n hatch (giÃ¢y)",
        Min = 0.1,
        Max = 5,
        Default = Options.HatchDelay.Value,
        Callback = function(value)
            Options.HatchDelay.Value = value
            warn("âœ… Hatch Delay:", value, "giÃ¢y")
        end
    })
    ConfigSystem.registerUIElement("HatchDelay", HatchDelaySlider)
    
    -- Auto hatch toggle
    local AutoHatchToggle = TabHatch:Toggle({
        Title = "ðŸ£ Auto Hatch Egg",
        Description = "Tá»± Ä‘á»™ng ná»Ÿ táº¥t cáº£ egg trong inventory",
        Default = false,
        Callback = function(state)
            if state then
                startAutoHatch()
            else
                HatchGlobals.isAutoHatching = false
            end
        end
    })
    ConfigSystem.registerUIElement("AutoHatchEgg", AutoHatchToggle)
    
    TabHatch:Divider({ Text = "Manual Actions" })
    
    -- Button mua 1 egg
    TabHatch:Button({
        Title = "ðŸ›’ Mua 1 Egg",
        Description = "Mua 1 egg thá»§ cÃ´ng",
        Callback = function()
            if not HatchGlobals.selectedEgg or HatchGlobals.selectedEgg == "" then
                libNoti("âŒ Vui lÃ²ng chá»n egg trÆ°á»›c!", 3)
                return
            end
            
            local success = buyEgg(HatchGlobals.selectedEgg, HatchGlobals.purchaseMethod)
            if success then
                libNoti("âœ… ÄÃ£ mua 1 " .. HatchGlobals.selectedEgg, 2)
            else
                libNoti("âŒ KhÃ´ng thá»ƒ mua egg!", 3)
            end
        end
    })
    
    -- Button hatch all
    TabHatch:Button({
        Title = "ðŸ£ Hatch All Eggs",
        Description = "Ná»Ÿ táº¥t cáº£ egg trong inventory (nháº¥n Ä‘Ãºp)",
        Callback = function()
            local count = hatchAllEggs()
            if count > 0 then
                libNoti("âœ… ÄÃ£ hatch " .. count .. " eggs", 3)
            else
                libNoti("âš ï¸ KhÃ´ng cÃ³ egg trong inventory", 3)
            end
        end
    })
    
    -- Button reset stats
    TabHatch:Button({
        Title = "ðŸ”„ Reset Statistics",
        Description = "Reset thá»‘ng kÃª session",
        Callback = function()
            HatchGlobals.totalEggsBought = 0
            HatchGlobals.totalEggsHatched = 0
            HatchGlobals.sessionStartTime = tick()
            saveHatchConfig()
            libNoti("âœ… ÄÃ£ reset thá»‘ng kÃª", 2)
        end
    })
    
    TabHatch:Divider({ Text = "Statistics" })
    
    -- Statistics paragraphs
    local StatsPara1 = TabHatch:Paragraph({
        Title = "ðŸ“Š Session Stats",
        Description = "Loading..."
    })
    
    local StatsPara2 = TabHatch:Paragraph({
        Title = "ðŸ¥š Eggs in Inventory",
        Description = "Loading..."
    })
    
    -- Update stats task
    task.spawn(function()
        while true do
            local eggsInInv = #findEggsInInventory()
            local sessionTime = tick() - (HatchGlobals.sessionStartTime > 0 and HatchGlobals.sessionStartTime or tick())
            
            StatsPara1:SetDesc(string.format(
                "Bought: %s | Hatched: %s\nSession Time: %s",
                formatNumber(HatchGlobals.totalEggsBought),
                formatNumber(HatchGlobals.totalEggsHatched),
                timeElapsed(math.floor(sessionTime))
            ))
            
            StatsPara2:SetDesc(string.format("%d eggs", eggsInInv))
            
            task.wait(1)
        end
    end)
    
    -- Load config
    loadHatchConfig()
end

-- ==================== INIT MODULE ====================
function Module:Init()
    createAutoHatchTab()
    warn("âœ… Auto Hatch Module loaded!")
    libNoti("âœ… Auto Hatch Module Ä‘Ã£ sáºµn sÃ ng!", 3)
end

return Module
